# CargoFlow — Система за управление на клиентски заявки (ClientRequests)

**Дата:** 2026-02-13
**За:** Вътрешна документация
**Папка:** `C:\Python_project\CargoFlow\ClientRequests\`

---

## 1. КАКВО Е CLIENTREQUESTS

ClientRequests е **файлово базирана система** за структурирано улавяне, проследяване и управление на клиентски заявки, които идват **извън** автоматизирания email pipeline на CargoFlow.

### Проблемът, който решава

CargoFlow обработва имейли автоматично (Email Fetcher → OCR → AI → File Organizer), но клиентските изисквания идват от различни канали:

| Канал | Пример | Преди ClientRequests |
|-------|--------|---------------------|
| Имейл нишка | 10 съобщения с уточнения | Губеше се в кореспонденцията |
| Teams среща | 55 мин. дискусия, 304 съобщения | Оставаше без запис |
| Физическа среща | 30 мин. разговор | Само бележки на хартия |
| Телефонно обаждане | Бързо уточнение | Нищо не се записваше |
| PDF спецификация | Формален документ на бланка | Не се свързваше с историята |
| Наблюдение | Агентът забелязва проблем | Не се документираше |

**Без ClientRequests:** Изискванията се губят, историята е непроследима, решенията не се документират.

**С ClientRequests:** Всяко изискване получава уникален ID, структурирани метаданни, проследимост и връзка с техническите задачи.

---

## 2. АРХИТЕКТУРА

### Файлова структура

```
ClientRequests/
├── README.md              ← Инструкции за AI агента (7-стъпков workflow)
├── TEMPLATE.md            ← Празен шаблон за нова заявка
├── REGISTRY.md            ← Регистър на ВСИЧКИ заявки (централен индекс)
├── process_inbox.py       ← Автоматичен процесор (EML, MSG, TXT, MD + офис)
├── office_extractor.py    ← Извличане от DOCX/DOC/XLSX/XLS + Teams транскрипти
├── inbox/                 ← ВХОД: суров текст/файлове за обработка
├── processed/             ← Структурирани заявки (CR-YYYY-NNN.md)
│   ├── CR-2026-001.md
│   ├── CR-2026-002.md
│   ├── CR-2026-003.md
│   ├── CR-2026-004.md
│   ├── CR-2026-005.md
│   └── CR-2026-006.md
└── archive/               ← Завършени заявки
```

### ID формат

**`CR-YYYY-NNN`** — Client Request, година, пореден номер (001-999)

Примери: CR-2026-001, CR-2026-002, CR-2026-006

---

## 3. РАБОТЕН ПРОЦЕС (WORKFLOW)

### Входни точки

```
┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐
│  Човек слага     │   │  Агентът         │   │  (Бъдещо)        │
│  файл в inbox/   │   │  забелязва нужда │   │  Email Fetcher   │
│  (EML, TXT, MD,  │   │  и създава файл  │   │  разпознава      │
│  DOCX, XLSX...)  │   │  в inbox/        │   │  "[ЗАЯВКА]" в    │
└────────┬─────────┘   └────────┬─────────┘   │  subject         │
         │                      │              └────────┬─────────┘
         └──────────────────────┴───────────────────────┘
                                │
                                ▼
```

### 7-стъпков процес

```
Стъпка 1: Прочети суровия вход от inbox/
    │
    ├── За EML/MSG → process_inbox.py (метаданни + тяло)
    ├── За DOCX/XLSX → office_extractor.py (текст)
    ├── За PDF → pdf_extractor.py (текст + изображения)
    └── За TXT/MD → директно четене
    │
    ▼
Стъпка 2: Определи следващото ID (от REGISTRY.md)
    │
    ▼
Стъпка 3: Попълни шаблона (TEMPLATE.md)
    │
    ├── Метаданни: дата, клиент, отговорник, тема
    ├── Категория: transport / документи / фактури / договори / техническо / друго
    ├── Източник: имейл / разговор / телефон / документ / наблюдение / чат
    ├── Приоритет: критичен / висок / среден / нисък
    ├── Статус: нова → в_изпълнение → завършена
    ├── Свързан договор: 50XXXXXXXXX / 20XXXXXXXXX
    └── Свързан имейл ID
    │
    ▼
Стъпка 4: Запази в processed/CR-YYYY-NNN.md
    │
    ▼
Стъпка 5: Обнови REGISTRY.md
    │
    ▼
Стъпка 6: Генерирай записи в .memory/
    │
    ├── TODO.md — секция "КЛИЕНТСКИ ЗАЯВКИ" с конкретни действия
    ├── PROBLEMS.md — ако заявката описва проблем
    └── LOG.md — запис за създаване на заявката
    │
    ▼
Стъпка 7: Потвърди на потребителя (резюме)
```

---

## 4. ИНСТРУМЕНТИ

### 4.1 process_inbox.py

**Предназначение:** Главен процесор — извлича метаданни и тяло от входящи файлове.

**Поддържани формати:**
| Формат | Как обработва |
|--------|--------------|
| `.eml` | email.parser — headers, body, attachments |
| `.msg` | msg-extractor — Outlook формат |
| `.txt` | Директно четене |
| `.md` | Директно четене |
| `.docx, .xlsx...` | Делегира към office_extractor.py |

**Ключови функции:**
- Извличане на sender, subject, date, recipients от EML/MSG
- Извличане на body (plain text + HTML fallback)
- Откриване и извличане на прикачени файлове
- Интеграция с OfficeExtractorBridge за офис формати

### 4.2 office_extractor.py

**Предназначение:** Извличане на текст от офис документи + Teams транскрипти.

**Базиран на:** `Cargoflow_Office/office_processor.py` (оригиналът НЕ е пипнат)

**Разлики от оригинала:**
| Аспект | Оригинал (office_processor.py) | ClientRequests (office_extractor.py) |
|--------|-------------------------------|--------------------------------------|
| PostgreSQL | ✅ Записва в DB | ❌ Без DB зависимости |
| Watchdog | ✅ Real-time мониторинг | ❌ On-demand извикване |
| Teams парсер | ❌ Няма | ✅ TeamsTranscriptParser |
| EML поддръжка | ❌ | ✅ Извлича офис от attachments |
| Интеграция | Самостоятелен модул | Чрез OfficeExtractorBridge |

**Поддържани формати:**
| Формат | Библиотека |
|--------|------------|
| DOCX | python-docx |
| DOC | win32com (MS Office) |
| XLSX | openpyxl |
| XLS | xlrd |
| RTF | pypandoc |
| TXT | директно |
| XML | xml.etree |
| ODT | pypandoc |

**TeamsTranscriptParser:**
- Парсва Teams транскрипт DOCX файлове
- Извлича: участници, съобщения с времена, продължителност
- Структуриран изход: кой какво е казал и кога

### 4.3 pdf_extractor.py

**Предназначение:** Извличане на текст и изображения от PDF файлове.

**Базиран на:** `Cargoflow_OCR/ocr_processor.py` (оригиналът НЕ е пипнат)

**Разлики от оригинала:**
| Аспект | Оригинал (ocr_processor.py) | ClientRequests (pdf_extractor.py) |
|--------|----------------------------|-----------------------------------|
| PostgreSQL | ✅ Записва в DB | ❌ Без DB зависимости |
| Watchdog | ✅ Real-time мониторинг | ❌ CLI инструмент |
| EML поддръжка | ❌ | ✅ Извлича PDF от EML |
| CLI | ❌ | ✅ --mode text/images/both |

**CLI примери:**
```bash
# Извлечи текст от PDF
python pdf_extractor.py --input document.pdf --mode text

# Извлечи PDF от EML
python pdf_extractor.py --input email.eml --mode both

# Принудителни изображения (дори за текстов PDF)
python pdf_extractor.py --input document.pdf --mode images --force-images
```

---

## 5. ОБРАБОТЕНИ ЗАЯВКИ

### Хронология

| ID | Дата | Източник | Описание | Генерирани задачи |
|----|------|----------|----------|-------------------|
| CR-2026-001 | 22.09.2025 | EML имейл | Оригинална спецификация на клиента — автоматизация на документи | 6 задачи |
| CR-2026-002 | 22.09-13.11.2025 | EML нишка (10 имейла) | Пълна кореспонденция — уточнения и обратна връзка | 9 задачи, 2 проблема |
| CR-2026-003 | 05.02.2026 | Teams транскрипт (DOCX) | Teams среща: фокус CMR/фактури, 55 мин, 304 съобщения, 4 участника | 8 задачи, 3 проблема |
| CR-2026-004 | 06.02.2026 | Аудио транскрипт (TXT) | Физическа среща: POD видове, обработка на снимки, процеси | 8 задачи, 3 проблема |
| CR-2026-005 | 09.02.2026 | EML имейл | Phase 1 definition — официална MVP спецификация | 10 задачи, 4 проблема (⚠️ заменена от CR-006) |
| CR-2026-006 | 12.02.2026 | EML + PDF на бланка | **АКТУАЛНА:** Коригирано задание — окончателна Phase 1 спецификация | 11 задачи, 5 проблема |

### Ключови открития от заявките

| Заявка | Ключово откритие | Ефект върху системата |
|--------|------------------|----------------------|
| CR-001 | Оригинални изисквания: папки по 50X, AI класификация | Основата за цялата система |
| CR-002 | 4-нивова дубликат защита е нужна, 30-50 имейла/ден | Затвърди Email Fetcher архитектурата |
| CR-003 | Номер 50/20 НЕ Е в CMR, 90% групажни, 2 крайни папки | Промени в contract detection стратегията |
| CR-004 | POD = 3 вида (международно CMR, клиентски CMR, товарителница), обработка на снимки | Нови AI категории, image processing |
| CR-005 | Печат на POD (склад/не), Invoice naming, данни извличане | Stamp detection модул, invoice_base |
| CR-006 | Ордер 202Х, "заявка към превозвач", POD_N/WH_N naming | 20-pattern, booking_request, нова номенклатура |

### Еволюция на изискванията

```
CR-001 (22.09.2025)  ── Оригинална идея: "папки по номер, AI класификация"
    │
CR-002 (09-11.2025)  ── Уточнения: "дубликати, формати, капацитет"
    │
CR-003 (05.02.2026)  ── Teams среща: "фокус CMR+фактури, 2 папки, групажи"
    │
CR-004 (06.02.2026)  ── Физическа среща: "3 вида POD, снимки, суфикси"
    │
CR-005 (09.02.2026)  ── Формална спецификация: "печат, invoice naming, CSV"
    │
CR-006 (12.02.2026)  ── КОРИГИРАНО задание: "202Х, booking_request, POD_N/WH_N"
                         ↑ АКТУАЛНО — заменя CR-005
```

---

## 6. ИНТЕГРАЦИЯ С CARGOFLOW

### Връзка с .memory/ системата

| .memory/ файл | Как се обновява от ClientRequests |
|----------------|-----------------------------------|
| `TODO.md` | Секция "КЛИЕНТСКИ ЗАЯВКИ" — задачи по всяка заявка |
| `PROBLEMS.md` | Проблеми с таг [CR-YYYY-NNN] |
| `LOG.md` | Запис за създаване/обновяване на заявки |
| `DECISIONS.md` | Решения взети на базата на заявки |
| `STATE.md` | Референция към ClientRequests секция |

### Връзка с CargoFlow базата данни

Заявките могат да се свържат с:

| CargoFlow данни | SQL | Пример |
|----------------|-----|--------|
| Имейли | `SELECT * FROM emails WHERE subject LIKE '%keyword%'` | CR-002 свързан с email thread |
| Договори | `SELECT * FROM contracts WHERE contract_number = '50XXXXXXXXX'` | Конкретен номер на позиция |
| Фактури | `SELECT * FROM invoice_base WHERE invoice_number = 'XXX'` | Проблем с фактура |

### Връзка с doc/ документалната серия

ClientRequests е **входната точка** за документалната серия:

```
ClientRequests (6 заявки)
    │
    └── CR-2026-006 (актуално задание)
        │
        └── doc/SPEC.md (спецификация от CR-006)
            │
            ├── doc/TASKS.md (задачи)
            ├── doc/QUESTIONS.md (въпроси)
            ├── doc/REAL_ANALYSIS.md (код анализ)
            ├── doc/EFFORT_ESTIMATE.md (196ч оставащо)
            ├── doc/SYSTEM_VALUE_ESTIMATE.md (340ч изградено)
            ├── doc/FULL_PROJECT_PLAN.md (533ч от нулата)
            └── doc/REQUIREMENTS_TRACEABILITY.md (изискване → код)
```

---

## 7. СТАТИСТИКА

| Метрика | Стойност |
|---------|----------|
| **Общо заявки** | 6 |
| **Активни** | 5 |
| **Заменени** | 1 (CR-005 → CR-006) |
| **Общо генерирани задачи** | 52 |
| **Общо генерирани проблеми** | 17 |
| **Инструменти** | 3 (process_inbox.py, office_extractor.py, pdf_extractor.py) |
| **Поддържани формати** | 15+ (EML, MSG, TXT, MD, DOCX, DOC, XLSX, XLS, RTF, XML, ODT, PDF, Teams транскрипт) |
| **Период на заявките** | 22.09.2025 — 12.02.2026 (~5 месеца) |
| **Участници** | Spas Balinov, Dafin Balinov, Elitsa Atanasova, Todor Dzhambazov, Svetoslav Partenev |

---

## 8. IRON RULES

1. **REGISTRY ВИНАГИ АКТУАЛЕН** — Никога не създавай заявка без да обновиш REGISTRY.md
2. **СУРОВИЯТ ТЕКСТ СЕ ЗАПАЗВА** — Оригиналният текст от клиента не се редактира
3. **ПРИОРИТЕТЪТ Е ОБЕКТИВЕН** — Не занижавай приоритет без причина
4. **КРЪСТОСАНИ РЕФЕРЕНЦИИ** — Винаги свързвай с TODO.md и PROBLEMS.md
5. **BACKUP ПРЕДИ РЕДАКЦИЯ** — Преди промяна на REGISTRY.md, провери целостта
6. **НЕ ДУБЛИРАЙ** — Провери REGISTRY.md преди да създадеш нова заявка за същата тема
7. **ID Е УНИКАЛНО** — Никога не използвай повторно ID

---

## 9. СТОЙНОСТ НА СИСТЕМАТА

### Какво дава ClientRequests на проекта

| Аспект | Преди | След |
|--------|-------|------|
| **Проследимост** | Изискванията се губят в имейли | Всяко изискване има ID и история |
| **Структура** | Свободен текст, разпръснат | Стандартизиран шаблон, категории, приоритети |
| **Еволюция** | Не е ясно какво е променено | Хронология CR-001 → CR-006, diff между версии |
| **Автоматизация** | Ръчно четене на всяко съобщение | process_inbox.py + office_extractor.py |
| **Мултиформат** | Само текст | 15+ формата (EML, DOCX, PDF, Teams, аудио транскрипт) |
| **Интеграция** | Изолирана информация | Връзки с DB (emails, contracts, invoices) |
| **Знание** | Загубено между сесии | Запазено в .memory/ системата |

### Еквивалентно усилие

| Компонент | Часове | Описание |
|-----------|--------|----------|
| Проектиране на системата | 4 | Структура, шаблон, workflow, категории |
| README.md (инструкции) | 3 | 282 реда, 7-стъпков процес, IRON RULES |
| TEMPLATE.md | 1 | Markdown шаблон с всички полета |
| process_inbox.py | 8 | EML/MSG парсер, офис bridge, metadata extraction |
| office_extractor.py | 10 | 8 формата + Teams парсер, без DB зависимости |
| pdf_extractor.py | 6 | PDF текст/изображения, EML поддръжка, CLI |
| Обработка на 6 заявки | 16 | Анализ, попълване, генериране на задачи/проблеми |
| REGISTRY.md поддръжка | 2 | Централен индекс, хронология, статистика |
| **ОБЩО** | **~50ч** | **~6.25 работни дни** |

---

*Създаден: 2026-02-13*
*Базиран на: ClientRequests/README.md, REGISTRY.md, process_inbox.py, office_extractor.py*

# CargoFlow Automate — Хронология и Gap Анализ

**Документ:** Времева линия на комуникацията + анализ на разминаването между Phase 1 и текущата система
**Дата:** 2026-02-12
**Автор:** AI агент (ITservices)
**Заявки:** CR-2026-001 до CR-2026-005

---

# ЧАСТ 1: ХРОНОЛОГИЯ

## Времева линия: Какво е искано и какво е правено

---

### 22 септември 2025 — Оригинална спецификация (CR-2026-001)

**Какво иска клиентът:**
Spas Balinov изпраща имейл с първата спецификация. Описва 6 типа входящи имейли от превозвачи. Иска:
- Папка за всеки имейл с номер 50/20 в името
- Максимум 2 документа в папка: фактура + POD
- PDF формат, изчистени снимки, изправена ориентация
- Бъдещо: частни случаи + интеграция с Транзит

**Какво правим ние:**
Стартираме проектиране на CargoFlow. Задаваме уточняващи въпроси на същия ден.

**Клиентът уточнява (22.09):**
- САМО имейли с номер 50ХХ/20ХХ се обработват, останалите се игнорират
- Нови папки от нула (няма съществуващи)
- 30-50 имейла/ден (сега), до 150-200 (бъдещо)
- Обработка в рамките на деня (средно 5-10 мин/имейл ръчно)

---

### 24 септември 2025 — Допълнителни изисквания (CR-2026-002)

**Какво иска клиентът:**
Spas добавя 2 нови правила:
1. Обработен имейл = маркиран прочетен + оранжев цвят в Outlook
2. Имейли с номер 50/20 но БЕЗ прикачен файл = игнорират се

**Какво правим ние:**
Включваме в спецификацията. Работим по архитектурата.

---

### 4 октомври 2025 — Прогрес

**Какво правим ние:**
Светльо докладва прогрес по разработката.

**Клиентът казва:**
"Основното са номерата на ордер 20 и заявка 50."
Информацията за изпращача "нас не ни интересува."

---

### 15-17 октомври 2025 — Демо версия (CR-2026-002)

**Какво правим ние:**
Готова демо версия. Светльо изпраща линк към папки в OneDrive.

**Обратна връзка от клиента (17.10):**
1. Липсващи фактури — в папките има само CMR, но фактурите липсват
2. CMR не са преименувани
3. CMR не са изчистени — има крака, килими, лош контраст

**Какво следва:**
Проблемите се записват, работата продължава.

---

### 10-13 ноември 2025 — Корекции (CR-2026-002)

**Какво правим ние:**
Светльо прави промени по системата:
1. Извличане на номера от страниците на документите (не само от мейла)
2. Конвертиране на всички файлове в PDF
3. Именуване: `invoice_{номер}_{издател}.pdf`, `{category}_{name}.pdf`

**Какво казва клиентът:**
Иска обаждане за обсъждане. Разговорът не е записан.

---

### 15 ноември 2025 — СИСТЕМАТА СПИРА

**Какво се случва:**
Всички модули на CargoFlow спират. Последна активност: 15.11.2025 14:21.
Причина: неизвестна. Не е рестартирана до февруари 2026.

**Какво НЕ правим:**
~3 месеца без обработка. Документи се натрупват в пощата.

---

### 4-5 февруари 2026 — Рестарт на системата

**Какво правим ние:**
AI агент (нова сесия) извършва:
1. ONBOARD + ANALYZE на целия проект
2. Откриване на 246,254 дублирани записа в базата
3. Изчистване + UNIQUE constraint
4. Рестарт: Email Fetcher (107 имейла), OCR, Office, Text Queue (415 done)
5. Проблем: Image Queue Manager спрян с 349 pending

---

### 5 февруари 2026 — Teams среща (CR-2026-003)

**Участници:** Spas Balinov, Dafin Balinov (нов!), Elitsa Atanasova, Svetoslav Partenev
**Продължителност:** 55 минути, 304 съобщения

**Какво научаваме НОВО:**
1. Фокус на 1ви етап: САМО CMR + фактура (останалите 11 категории се игнорират)
2. Номер 50/20 НИКОГА не е в самото CMR — само във фактурата и тялото на мейла
3. 90%+ от транспортите са групажни (5-10 клиента в 1 камион)
4. Нужни са 2 крайни папки: вътрешна (всички) + клиентска (CMR + фактура)
5. Физическата обработка на снимки е най-времеемката задача
6. Планирана физическа среща за следващия ден

**Какво правим ние:**
Записваме всичко в CR-2026-003, генерираме 8 задачи и 3 проблема.

---

### 6 февруари 2026 — Физическа среща (CR-2026-004)

**Участници:** Svetoslav Partenev, Dafin Balinov, Elitsa Atanasova
**Място:** Офис на CargoFlow | **Транскрипт:** ~30 мин (TurboScribe, непълен)

**Какво научаваме НОВО:**
1. POD = 3 вида: международно CMR (24 клетки), клиентски CMR (различен формат), товарителница (българска)
2. Товарителница НЕ Е CMR, но Е POD
3. 95% от клиентите имат нужда САМО от POD + фактура
4. Задължителни полета в POD: изпращач, получател, описание, превозвач
5. Вход = САМО имейл (без сканиране)
6. Папки с суфикс `_1`, `_2` при повторни мейли по договор
7. Частни случаи: Kaufland (ваучъри за палети + амбалаж)
8. AI модел за проверка на качество на снимки — автоматично връщане при лошо качество
9. Нов OCR модел за четене на документи (излязъл наскоро)

**Какво правим ние:**
Демо на NotebookLM/Gemini за структуриране на разговори. Обещаваме да изпратим схема на процеса.

---

### 9 февруари 2026 — Phase 1 Definition (CR-2026-005)

**От:** Elitsa Atanasova / Todor Dzhambazov
**До:** AI@itservices.bg, todor@cargo-flow.fr

**ОФИЦИАЛНА MVP СПЕЦИФИКАЦИЯ:**

| # | Изискване | Описание |
|---|-----------|----------|
| 2.1 | Папки по позиция | 502xxxxxxxx, двата номера ако >1, суфикс _1 при повторение |
| 2.2 | Разделяне на документи | Многостранични PDF → отделни страници/документи |
| 2.3a | POD разпознаване | CMR, POD, Delivery note, товарителница |
| 2.3b | POD обработка | Изправяне, изрязване на фон → client-facing PDF |
| 2.3c | POD печат | Разпознаване дали печатът е на склад → различно именуване + копие |
| 2.3d | Invoice разпознаване | Тип "Invoice/Фактура" |
| 2.3e | Invoice naming | `invoice_<position>_<carrier>.pdf` |
| 2.4a | Invoice копие | Автоматично в отделна SharePoint папка |
| 2.4b | Invoice данни | Извличане: позиция, сума, дата, IBAN, превозвач → CSV/JSON |
| 2.4c | Invoice сравнение | Сравнение с Транзит CSV експорт |
| 2.5 | Конвертиране | Всички документи → отделни PDF |

---

### 12 февруари 2026 — Обработка и анализ (днес)

**Какво правим ние:**
1. Създадена система ClientRequests за проследяване на заявки
2. Обработени CR-2026-001 до CR-2026-005
3. Създаден office_extractor.py за Teams транскрипти
4. Създаден process_inbox.py за обработка на входящи файлове
5. Този документ — хронология + gap анализ

---

# ЧАСТ 2: GAP АНАЛИЗ

## Phase 1 Definition vs. Текуща система CargoFlow

---

### Легенда

| Символ | Значение |
|--------|----------|
| **РАБОТИ** | Функционалността е имплементирана и работи |
| **ЧАСТИЧНО** | Имплементирано, но не покрива всички изисквания |
| **НЕ РАБОТИ** | Имплементирано, но има проблем или не е тествано |
| **ЛИПСВА** | Не е имплементирано изобщо |
| **СПРЯНО** | Имплементирано, но модулът не е активен |

---

### 2.1 Автоматично създаване на папки по позиция

| Подизискване | Phase 1 Definition | Текущо състояние | Gap |
|-------------|-------------------|-----------------|-----|
| Пренасочване на документи от мейл към SharePoint | Автоматично | **РАБОТИ** — Contract Processor създава папки в OneDrive/SharePoint | - |
| Папка с номер на позиция | 502xxxxxxxx | **РАБОТИ** — regex_patterns.py търси 50XXXXXXXXX и 20XXXXXXXXX | - |
| Формат 502xxxxxxxx | Конкретен формат | **РАБОТИ** — `50\d{9}` pattern | - |
| Повече от 1 номер → двата в името | Двата номера | **РАБОТИ** — file_organizer.py комбинира номерата с `_` | - |
| Повтарящ се номер → суфикс _1 | naming convention _1, _2 | **РАБОТИ** — file_organizer.py добавя суфикс при дублиращи се папки | - |

**ОЦЕНКА: 5/5 — напълно покрито**

---

### 2.2 Разделяне на получените документи

| Подизискване | Phase 1 Definition | Текущо състояние | Gap |
|-------------|-------------------|-----------------|-----|
| Разделяне на многостранични PDF | На отделни страници/документи | **ЧАСТИЧНО** — OCR Processor разделя PDF на страници за OCR, но не ги записва като отделни документи | Страниците се създават за OCR анализ, но крайните файлове остават цели PDF |
| Поддържани формати | PDF, изображения, други | **РАБОТИ** — PDF, JPG, PNG, BMP, GIF, TIFF, DOCX, XLSX и др. | - |

**ОЦЕНКА: 1.5/2**
**GAP:** Системата разделя PDF на страници за OCR, но не генерира отделни PDF файлове за всеки документ вътре в мулти-документ PDF. Ако имейлът съдържа 1 PDF с фактура на стр.1 и CMR на стр.2-3, системата го анализира правилно, но не създава 2 отделни PDF файла.

---

### 2.3 Разпознаване на основни типове документи — POD

| Подизискване | Phase 1 Definition | Текущо състояние | Gap |
|-------------|-------------------|-----------------|-----|
| Разпознаване като POD | CMR, POD, Delivery note, товарителница | **ЧАСТИЧНО** — n8n класифицира "cmr" като категория, но не разпознава товарителница или Delivery note като POD | Категорията е "cmr", не "pod". Товарителницата и клиентски CMR не са отделни категории |
| Обработка на изображение | Изправяне, изрязване на фон | **ЛИПСВА** — няма модул за image cleanup/background removal | Критичен gap — клиентът многократно иска тази функция |
| Client-facing PDF | Четим, чист документ | **ЧАСТИЧНО** — конвертиране в PDF работи, но без изчистване | PDF се създава, но не е "client-facing" |
| Разпознаване на печат | Дали е на склад CargoFlow | **ЛИПСВА** — няма модул за разпознаване на печати | Нова функция, не е обсъждана преди Phase 1 |
| Различно именуване при липса на печат | Име + копие в друга папка | **ЛИПСВА** — зависи от горната точка | Нова функция |

**ОЦЕНКА: 1/5**
**КРИТИЧНИ GAPS:**
1. Image cleanup/background removal — липсва напълно
2. POD категория е само "cmr" — не покрива товарителница и custom CMR
3. Разпознаване на печат — нова функция, не е имплементирана

---

### 2.3 Разпознаване на основни типове документи — Invoice

| Подизискване | Phase 1 Definition | Текущо състояние | Gap |
|-------------|-------------------|-----------------|-----|
| Разпознаване като Invoice | Тип "Invoice/Фактура" | **РАБОТИ** — n8n класифицира "invoice" като категория | - |
| Конвертиране в PDF | PDF формат | **РАБОТИ** — file_organizer.py конвертира | - |
| Naming convention | `invoice_<position>_<carrier>.pdf` | **ЧАСТИЧНО** — текущо: `invoice_{номер}_{издател}.pdf` (от 13.11.2025) | Форматът е близък, но "издател" може да не съвпада с "name of Subcontractor" |

**ОЦЕНКА: 2.5/3**
**GAP:** Naming convention е близък, но трябва верификация че "издател" = "Subcontractor name" и че форматът съвпада точно.

---

### 2.4 Допълнителна обработка на Invoice

| Подизискване | Phase 1 Definition | Текущо състояние | Gap |
|-------------|-------------------|-----------------|-----|
| Копие в отделна SharePoint папка | Автоматично копие | **ЛИПСВА** — фактурата се записва САМО в основната папка по договор | Нова функция — нужен е втори path за копие |
| Извличане на ключови данни | Позиция, сума, дата, IBAN, превозвач → CSV/JSON | **ЧАСТИЧНО** — n8n извлича позиция и някои данни, но НЕ ги записва в CSV/JSON формат | Данните се извличат частично за класификация, но не се експортират |
| Сравнение с Транзит CSV | Сравнение на извлечени данни | **ЛИПСВА** — няма модул за сравнение с Транзит | Нова функция. Имаме пример CSV (Table_01.csv) |

**ОЦЕНКА: 0.5/3**
**КРИТИЧНИ GAPS:**
1. Копие на Invoice в отделна папка — не е имплементирано
2. Извличане на данни в CSV/JSON — не е имплементирано
3. Сравнение с Транзит — не е имплементирано

---

### 2.5 Конвертиране на документи

| Подизискване | Phase 1 Definition | Текущо състояние | Gap |
|-------------|-------------------|-----------------|-----|
| Всички документи в PDF | Отделни PDF файлове | **РАБОТИ** — file_organizer.py конвертира (от 13.11.2025) | - |
| Документи различни от Invoice/POD | Без преименуване, в съответната папка | **РАБОТИ** — останалите документи се записват с оригинално име | - |

**ОЦЕНКА: 2/2**

---

### Допълнителни изисквания (от CR-2026-001 до CR-2026-004, не в Phase 1 Definition)

| Изискване | Източник | Текущо състояние |
|-----------|----------|-----------------|
| Маркиране на мейл: прочетен + оранжев | CR-2026-002 | **ЧАСТИЧНО** — Email Fetcher може да маркира, нужна проверка |
| Игнориране на мейли без attachment | CR-2026-002 | **РАБОТИ** — `hasAttachments=true` филтър |
| Само мейли с номер 50/20 | CR-2026-002 | **РАБОТИ** — contract detection |
| 2 крайни папки (вътрешна + клиентска) | CR-2026-003 | **ЛИПСВА** — не е в Phase 1 Definition, но обсъждано |
| Групажна логика (CMR → правилен клиент) | CR-2026-003 | **ЛИПСВА** — не е в Phase 1, Phase 2 |
| AI проверка качество на снимки | CR-2026-004 | **ЛИПСВА** — не е в Phase 1 формално |
| Частни случаи: Kaufland | CR-2026-004 | **ЛИПСВА** — не е в Phase 1, Phase 2 |

---

## ОБОБЩЕНА ОЦЕНКА

### Phase 1 Requirements Score

| Секция | Изисквания | Покрити | Частични | Липсващи | Оценка |
|--------|-----------|---------|----------|----------|--------|
| 2.1 Папки по позиция | 5 | 5 | 0 | 0 | **100%** |
| 2.2 Разделяне на документи | 2 | 1 | 1 | 0 | **75%** |
| 2.3 POD | 5 | 0 | 2 | 3 | **20%** |
| 2.3 Invoice | 3 | 2 | 1 | 0 | **83%** |
| 2.4 Invoice обработка | 3 | 0 | 1 | 2 | **17%** |
| 2.5 Конвертиране | 2 | 2 | 0 | 0 | **100%** |
| **ОБЩО** | **20** | **10** | **5** | **5** | **62%** |

### Визуализация

```
Phase 1 Coverage:

2.1 Папки        ████████████████████ 100%
2.2 Разделяне    ███████████████░░░░░  75%
2.3 POD          ████░░░░░░░░░░░░░░░░  20%  ← КРИТИЧЕН
2.3 Invoice      ████████████████░░░░  83%
2.4 Invoice обр. ███░░░░░░░░░░░░░░░░░  17%  ← КРИТИЧЕН
2.5 Конвертиране ████████████████████ 100%

ОБЩО:            ████████████░░░░░░░░  62%
```

---

## КРИТИЧНИ GAPS (приоритетно)

### ПРИОРИТЕТ 1: Без тях Phase 1 не може да се демонстрира

| # | Gap | Сложност | Оценка време |
|---|-----|---------|-------------|
| 1 | **POD image cleanup** — изправяне, изрязване на фон, client-facing PDF | Средна | 2-3 дни |
| 2 | **POD разширяване** — товарителница + клиентски CMR като POD категория | Ниска | 0.5-1 ден |
| 3 | **Invoice копие** в отделна SharePoint папка | Ниска | 0.5 ден |

### ПРИОРИТЕТ 2: Основна Phase 1 функционалност

| # | Gap | Сложност | Оценка време |
|---|-----|---------|-------------|
| 4 | **Invoice данни** извличане → CSV/JSON | Средна | 2-3 дни |
| 5 | **Multi-page PDF** разделяне на отделни документи | Средна | 1-2 дни |
| 6 | **Invoice naming** верификация на формат `invoice_<pos>_<carrier>.pdf` | Ниска | 0.5 ден |

### ПРИОРИТЕТ 3: Нови функции от Phase 1

| # | Gap | Сложност | Оценка време |
|---|-----|---------|-------------|
| 7 | **POD печат** разпознаване (склад или не) | Висока | 3-5 дни |
| 8 | **Invoice сравнение** с Транзит CSV | Средна | 2-3 дни |

### Общо оценено време: 12-18 работни дни

---

## КАКВО РАБОТИ ДОБРЕ (не изисква промени)

1. Email Fetcher — извлича имейли, записва прикачени файлове
2. OCR Processor — обработва PDF и изображения, извлича текст
3. Office Processor — обработва DOCX, XLSX и др.
4. Queue Managers — изпраща към n8n за AI класификация
5. n8n Workflows — класифицира документи (13 категории, invoice/cmr/other)
6. Contract Detector — открива номера 50/20 в документи и мейли
7. File Organizer — създава папки, конвертира в PDF, организира по договори
8. PDF конвертиране — работи за всички основни формати

---

## ПРЕПОРЪКИ ЗА ПЛАН НА ДЕЙСТВИЕ

### Фаза А: Quick Wins (1 седмица)
1. Разширяване на POD категорията в n8n (товарителница, delivery note)
2. Invoice копие в отделна папка
3. Верификация на Invoice naming convention
4. Разширяване на Image Queue Manager (рестарт + мониторинг)

### Фаза Б: Core Image Processing (1-2 седмици)
1. Background removal модул за POD снимки
2. Изправяне на ориентация на снимки
3. Client-facing PDF генериране
4. AI проверка на качество

### Фаза В: Data Extraction (1-2 седмици)
1. Invoice данни извличане (позиция, сума, дата, IBAN, превозвач)
2. CSV/JSON експорт
3. Multi-page PDF разделяне

### Фаза Г: Advanced Features (2-3 седмици)
1. POD печат разпознаване
2. Сравнение с Транзит CSV
3. Тестване и стабилизация

---

**Документът е създаден на:** 2026-02-12
**Базиран на:** CR-2026-001 до CR-2026-005
**Следваща стъпка:** Одобрение от клиента и приоритизиране
